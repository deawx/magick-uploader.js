/* 
 * magick-uploader.js v0.0.1 
 * http://ocapi.github.com/magick-uploader.js
 * 
 * @copyright 2013 Endel Dreyer 
 * @license MIT
 * @build 1/22/2013
 */
(function(t,e,i){i.fn.MagickUploader=function(e){e||(e={}),e.smooth=e.smooth||!0,e.accept=e.accept||null,e.label=e.label||null,e.extensions=e.extensions||null,e.filereader||(e.filereader="deps/filereader.swf"),e.expressInstall||(e.expressInstall="deps/expressInstall.swf");var s={};return i(["multiple","accept","label","extensions","filereader","debugMode","callback"]).each(function(t,i){e[i]&&(s[i]=e[i])}),i(["resize"]).each(function(t,i){e.process={},e[i]&&(e.process[i]=e[i])}),this.each(function(h,n){var o=i(n).attr("name"),g=i('<input name="'+o+'" type="hidden" />');s.id="fileReaderPolyfill"+(""+h),i(n).after(g),i(n).on("change",function(t){for(var s=0,h=t.target.files.length;h>s;++s){var n=new a(i.extend(e,{result:g})),o=new FileReader;o.onload=function(t){n.loadImage(t.target.result)},o.readAsDataURL(t.target.files[s])}i(this).before(i(this).clone()).remove()}),t.FileAPIProxy!==undefined&&i(n).fileReader(s),i(n).attr("name",o+"_file")})};var a=function(t){this.options=t,this.canvas=this.createCanvas(t.preview),this.ctx=this.canvas.getContext("2d"),this.image=new Image,t.smooth&&(this.ctx.webkitImageSmoothingEnabled=t.smooth,this.ctx.imageSmoothingEnabled=t.smooth,this.ctx.mozImageSmoothingEnabled=t.smooth,this.ctx.oImageSmoothingEnabled=t.smooth),this.result=t.result};a.prototype.createCanvas=function(t){var a=e.createElement("canvas");return console.log("Container!",t),t&&i(t).append(a),"undefined"!=typeof FlashCanvas&&FlashCanvas.initElement(a),a},a.prototype.loadImage=function(t){var e=this;this.image.onload=function(){e.process()},this.image.src=t},a.prototype.process=function(){var t=this;i.each(this.options.process,function(e,i){i instanceof Array||(i=[i]),t[e].apply(t,i)}),setInterval(function(){i(t.result).val(t.canvas.toDataURL())},10)},a.prototype.resizeCanvas=function(t,e){this.canvas.width=t,this.canvas.height=e},a.prototype.resize=function(t){var e=(this.image.width,this.image.height,t.match(/([0-9]+)/g)),i=parseInt(e[0],10),a=parseInt(e[0]||e[1],10),s=t.match(/[!\<>\^\%]?$/),h=0,n=0,o=1,g=1;this.resizeCanvas(i,a),"!"==s?(this.image.width=i,this.image.height=a):"^"==s?(o=i/this.image.width,g=a/this.image.height,i=this.image.width,a=this.image.height,this.resizeCanvas(i*o,a*g),this.ctx.scale(o,g),h=(this.canvas.width-i)/2,n=(this.canvas.height-a)/2):"%"==s?(o=i/100,g=a/100,i=this.image.width*o,a=this.image.height*g,this.resizeCanvas(i,a),this.ctx.scale(o,g)):"<"==s?(i=Math.max(this.image.width,i),a=Math.max(this.image.height,a),i>this.image.width&&(a=this.image.height*(i/this.image.width)),a>this.image.height&&(i=this.image.width*(a/this.image.height)),this.resizeCanvas(i,a)):">"==s?(i=Math.min(this.image.width,i),a=Math.min(this.image.height,a),this.image.width!=i&&(a=this.image.height*(i/this.image.width)),this.image.height!=a&&(i=this.image.width*(a/this.image.height)),this.resizeCanvas(i,a)):(this.image.width!=i&&(a=this.image.height*(i/this.image.width)),this.image.height!=a&&(i=this.image.width*(a/this.image.height)),this.resizeCanvas(i,a)),this.ctx.drawImage(this.image,h,n,i,a)}})(this,this.document,jQuery);